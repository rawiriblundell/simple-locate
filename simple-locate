#!/bin/sh
# shellcheck disable=SC2006
# Purpose:   Provide 'locate' type functionality to systems without it
# Author:    Rawiri Blundell
# Copyright: MIT licence
# Date:      20160503

# Style note: This uses awful backticks for SVR4 compatibility

# Direct Solaris to use xpg4 utils, which don't suck:
if [ "`uname`" = SunOS ]; then
  PATH=/usr/xpg4/bin:$PATH
  export PATH
fi

# Select a destination directory
destDir=/var/lib/simple-locate

# Define a maximum age in days for the list before we complain
maxAge=7

# Figure out our tmp directory.  If destDir doesn't exist, we check here next.
if [ -d /tmp ]; then
  tmpDir=/tmp
elif [ -d /var/tmp ]; then
  tmpDir=/var/tmp
elif [ -d /usr/tmp ]; then
  tmpDir=/usr/tmp
fi

# If destDir doesn't exist, revert to tmpDir
if [ ! -d "${destDir}" ]; then
  destDir="${tmpDir}"
fi

# If the user is root, we can search the root file
if [ -w / ]; then
  listFile="${destDir}"/locate.root
else
  listFile="${destDir}"/locate.user
fi

# If we are launched without any args, output usage
if [ -z "$*" ]; then
  printf "%s\n" "simple-locate - a poor sysadmin's 'locate' alternative" "" \
    "This program is basically a veneer-thin wrapper for 'egrep'" \
    "It selects either a root-readable db or a user-readable db" \
    "depending on whether you're root or not." "" \
    "Everything you command is passed otherwise verbatim to 'egrep'" \
    "so all 'egrep' options apply to this program too."
  exit 0
fi

# Now check that the file exists
if [ ! -f "${listFile}" ]; then
  if command -v update-smlocate >/dev/null 2>&1; then
    printf "%s\n" "[INFO] - smlocate: ${listFile} not found, attempting to generate it with 'update-smlocate'"
    update-smlocate 2>/dev/null
  else
    printf "%s\n" "[INFO] - smlocate: ${listFile} does not appear to exist, and 'update-smlocate' couldn't be found."
    exit 1
  fi
fi

# Check the file's age and warn if it exceeds maxAge
# Note the brackets here are required as 'find' always returns 0
if [ find "${listFile}" -mtime +"${maxAge}" >/dev/null 2>&1 ]; then
  printf "%s\n" "[INFO] - smlocate: ${listFile} is older than ${maxAge} days old." \
    "Please run 'update-smlocate', and investigate setting it up as a cron job." \
    "This will ensure that search results stay up to date." "---"
fi

# Finally, pass everything to egrep and sort the output
egrep "$@" "${listFile}" | sort | uniq
